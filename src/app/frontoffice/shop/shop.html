<ng-template #filtersContent>
  <details class="filter-block" open>
    <summary class="filter-summary">
      <span>Marque</span>
      <svg
        class="filter-chevron"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 9l-7 7-7-7"
        />
      </svg>
    </summary>
    <ul class="filter-list">
      @for (brand of brandList(); track brand) { @if (brand) {
      <li>
        <label class="filter-option">
          <input
            type="checkbox"
            [checked]="isBrandSelected(brand)"
            (change)="toggleBrand(brand)"
          />
          <span>{{ brand }}</span>
          <span class="filter-count">({{ getBrandCount(brand) }})</span>
        </label>
      </li>
      } }
    </ul>
  </details>

  <details class="filter-block">
    <summary class="filter-summary">
      <span>Prix</span>
      <svg
        class="filter-chevron"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 9l-7 7-7-7"
        />
      </svg>
    </summary>
    <div class="filter-stack">
      @for (range of priceRanges; track range.id) {
      <button
        type="button"
        class="filter-choice"
        [class.is-active]="isPriceRangeSelected(range.id)"
        (click)="selectPriceRange(range.id)"
      >
        {{ range.label }}
      </button>
      }
    </div>
  </details>

  <details class="filter-block">
    <summary class="filter-summary">
      <span>Largeur</span>
      <svg
        class="filter-chevron"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 9l-7 7-7-7"
        />
      </svg>
    </summary>
    <div class="filter-grid">
      @for (width of widthOptions(); track width) {
      <button
        type="button"
        class="filter-chip"
        [class.is-active]="isWidthSelected(width)"
        (click)="selectWidth(width)"
      >
        {{ width }}
      </button>
      }
    </div>
  </details>

  <details class="filter-block">
    <summary class="filter-summary">
      <span>Profil</span>
      <svg
        class="filter-chevron"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 9l-7 7-7-7"
        />
      </svg>
    </summary>
    <div class="filter-grid">
      @for (profile of profileOptions(); track profile) {
      <button
        type="button"
        class="filter-chip"
        [class.is-active]="isProfileSelected(profile)"
        (click)="selectProfile(profile)"
      >
        {{ profile }}
      </button>
      }
    </div>
  </details>

  <details class="filter-block">
    <summary class="filter-summary">
      <span>Diamètre</span>
      <svg
        class="filter-chevron"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 9l-7 7-7-7"
        />
      </svg>
    </summary>
    <div class="filter-grid">
      @for (diameter of diameterOptions(); track diameter) {
      <button
        type="button"
        class="filter-chip"
        [class.is-active]="isDiameterSelected(diameter)"
        (click)="selectDiameter(diameter)"
      >
        {{ diameter }}
      </button>
      }
    </div>
  </details>

  <div class="filter-block mobile-only mobile-sort">
    <div class="mobile-sort__label">Trier par :</div>
    <div class="toolbar-select">
      <select [value]="selectedSort()" (change)="onSortChange($event)">
        @for (option of sortOptions; track option.id) {
        <option [value]="option.id">{{ option.label }}</option>
        }
      </select>
      <svg
        class="toolbar-chevron"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 9l-7 7-7-7"
        />
      </svg>
    </div>
  </div>
</ng-template>

<div class="min-h-screen bg-black">
  <app-header></app-header>

  <main class="shop-main">
    <div class="shop-container">
      <h1 class="shop-title">Produits</h1>

      <div class="products-toolbar mobile-only">
        <button class="filters-toggle" type="button" (click)="openFilters()">
          <svg
            class="filters-toggle__icon"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M3 4h18M4 12h16M6 20h12"
            />
          </svg>
          <span>Filtrer et trier</span>
        </button>
        <span class="products-count"
          >{{ totalProducts() }} produit{{ totalProducts() > 1 ? 's' : ''
          }}</span
        >
      </div>

      <div class="shop-layout">
        <aside class="filters-column desktop-only">
          <div class="filters-header">
            <span class="filters-label">Filtrer :</span>
            <button
              type="button"
              class="filters-reset"
              (click)="clearFilters()"
            >
              Tout supprimer
            </button>
          </div>
          <div class="filters-divider"></div>

          <ng-container *ngTemplateOutlet="filtersContent"></ng-container>
        </aside>

        <section class="products-column">
          <div class="products-toolbar desktop-only">
            <div class="products-toolbar__meta">
              <span class="toolbar-caption">Trier par :</span>
              <div class="toolbar-select">
                <select
                  [value]="selectedSort()"
                  (change)="onSortChange($event)"
                >
                  @for (option of sortOptions; track option.id) {
                  <option [value]="option.id">{{ option.label }}</option>
                  }
                </select>
                <svg
                  class="toolbar-chevron"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  />
                </svg>
              </div>
            </div>
            <span class="products-count"
              >{{ totalProducts() }} produit{{ totalProducts() > 1 ? 's' : ''
              }}</span
            >
          </div>

          <div class="products-grid">
            @if (isLoading()) {
            <div class="products-empty">
              <div class="flex items-center justify-center gap-2">
                <svg
                  class="animate-spin h-6 w-6 text-primary"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
                <span class="text-gray-400">Chargement des produits...</span>
              </div>
            </div>
            } @else { @for (product of sortedProducts(); track product.id) {
            <article class="product-card">
              <div class="product-card__image">
                <img
                  [src]="product.image"
                  [alt]="product.name"
                  loading="lazy"
                  onerror="this.src='/assets/img/placeholder.png'"
                />
              </div>
              <h3 class="product-card__name">{{ product.name }}</h3>
              <p class="product-card__brand">
                {{ product.brand?.name || 'Autre' }}
              </p>
              <p class="product-card__price">
                @if (product.fromPrice) { À partir de {{
                formatPrice(product.price) }} } @else { {{
                formatPrice(product.price) }} }
              </p>
              <button
                type="button"
                class="product-card__cta"
                (click)="addToCart(product)"
              >
                Ajouter au panier
              </button>
            </article>
            } @empty {
            <div class="products-empty">
              Aucun produit ne correspond à vos filtres.
            </div>
            } }
          </div>
        </section>
      </div>
    </div>
  </main>

  <div class="filters-drawer" [class.is-open]="isDrawerOpen()">
    <div class="filters-drawer__overlay" (click)="closeFilters()"></div>
    <div class="filters-drawer__panel">
      <header class="filters-drawer__header">
        <div>
          <div class="filters-drawer__title">Filtrer et trier</div>
          <div class="filters-drawer__subtitle">
            {{ totalProducts() }} produit{{ totalProducts() > 1 ? 's' : '' }}
          </div>
        </div>
        <button
          class="filters-drawer__close"
          type="button"
          (click)="closeFilters()"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </header>

      <div class="filters-drawer__content">
        <ng-container *ngTemplateOutlet="filtersContent"></ng-container>
      </div>

      <footer class="filters-drawer__footer">
        <button
          type="button"
          class="filters-drawer__action filters-drawer__action--ghost"
          (click)="clearFilters()"
        >
          Tout supprimer
        </button>
        <button
          type="button"
          class="filters-drawer__action"
          (click)="applyFilters()"
        >
          Appliquer
        </button>
      </footer>
    </div>
  </div>

  <app-footer></app-footer>
</div>
